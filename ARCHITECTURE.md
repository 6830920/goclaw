# Goclaw 系统架构

## 🏗️ 整体架构

Goclaw采用微内核架构，核心功能模块化设计，易于扩展和维护。

```
┌─────────────────┐    ┌─────────────────┐    ┌─────────────────┐
│   Web UI        │    │   API Client    │    │   CLI Tools     │
│   (React/Vue)   │    │   (REST API)    │    │   (Commands)    │
└─────────┬───────┘    └─────────┬───────┘    └─────────┬───────┘
          │                      │                      │
          └──────────────────────┼──────────────────────┘
                                 │
┌─────────────────────────────────────────────────────────────┐
│                    HTTP API 层                              │
│  ┌─────────────┐  ┌─────────────┐  ┌─────────────┐        │
│  │  Chat API   │  │ Memory API  │  │  Cron API   │        │
│  │             │  │             │  │             │        │
│  └─────────────┘  └─────────────┘  └─────────────┘        │
└─────────────────────────────────────────────────────────────┘
                                 │
┌─────────────────────────────────────────────────────────────┐
│                    核心服务层                                │
│  ┌─────────────┐  ┌─────────────┐  ┌─────────────┐        │
│  │ Chat Mgmt   │  │ Memory Mgmt │  │ Cron Mgmt   │        │
│  │             │  │             │  │             │        │
│  └─────────────┘  └─────────────┘  └─────────────┘        │
└─────────────────────────────────────────────────────────────┘
                                 │
┌─────────────────────────────────────────────────────────────┐
│                    存储层                                   │
│  ┌─────────────┐  ┌─────────────┐  ┌─────────────┐        │
│  │ Vector DB   │  │ Memory DB   │  │ Config DB   │        │
│  │             │  │             │  │             │        │
│  └─────────────┘  └─────────────┘  └─────────────┘        │
└─────────────────────────────────────────────────────────────┘
                                 │
┌─────────────────────────────────────────────────────────────┐
│                    AI 集成层                                │
│  ┌─────────────┐  ┌─────────────┐  ┌─────────────┐        │
│  │ Minimax     │  │ Qwen        │  │ Zhipu       │        │
│  │ Provider    │  │ Provider    │  │ Provider    │        │
│  └─────────────┘  └─────────────┘  └─────────────┘        │
└─────────────────────────────────────────────────────────────┘
```

## 📦 模块划分

### 1. cmd/ - 命令行入口
```
cmd/
└── server/
    ├── main.go           # 服务入口
    ├── handlers.go       # API处理器
    └── routes.go         # 路由定义
```

### 2. internal/ - 内部实现
```
internal/
├── chat/                 # 聊天会话管理
│   ├── manager.go        # 会话管理器
│   └── session.go        # 会话实体
├── config/               # 配置管理
│   └── config.go         # 配置结构
├── core/                 # 核心类型定义
│   └── types.go          # 基础类型
├── cron/                 # 定时任务
│   ├── cron.go           # 任务调度器
│   └── handler.go        # 任务处理器
├── memory/               # 记忆系统
│   └── memory.go         # 记忆管理
└── vector/               # 向量存储
    ├── embedding.go      # 嵌入引擎
    └── store.go          # 存储实现
```

### 3. pkg/ - 公共包
```
pkg/
└── ai/                   # AI接口抽象
    ├── client.go         # 客户端接口
    └── providers/        # 具体提供商
        ├── minimax.go
        ├── qwen.go
        └── zhipu.go
```

## 🌐 API架构

### RESTful API设计
- **统一格式**: JSON响应格式
- **错误处理**: 标准错误码
- **认证**: API密钥认证
- **限流**: 请求频率限制

### API版本控制
- **路径版本**: `/api/v1/`
- **向后兼容**: 保持向后兼容性
- **文档化**: 完整API文档

## 🤖 AI集成架构

### 多提供商支持
```
┌─────────────────┐
│  AI Client      │
│  (Multi-Provider)│
└─────────┬───────┘
          │
    ┌─────┴─────┐
    │ Provider  │
    │  Router   │
    └─────┬─────┘
    ┌─────┴─────┐ ┌─────┐ ┌─────┐
    │Minimax│ │Qwen │ │Zhipu│
    └───────┘ └─────┘ └─────┘
```

### 容错机制
- **失败切换**: 自动切换到备用提供商
- **重试策略**: 智能重试机制
- **缓存**: 响应缓存机制

## 🔐 安全架构

### 认证授权
- **API密钥**: 服务端API密钥
- **会话管理**: 安全会话管理
- **访问控制**: 权限控制机制

### 数据安全
- **加密传输**: HTTPS/TLS加密
- **数据隔离**: 用户数据隔离
- **隐私保护**: 数据最小化原则

## ⚡ 性能优化

### 缓存策略
- **内存缓存**: 热点数据缓存
- **响应缓存**: API响应缓存
- **会话缓存**: 会话状态缓存

### 并发处理
- **Goroutine**: Go协程并发
- **连接池**: 数据库连接池
- **队列**: 异步任务队列

## 🔄 扩展性设计

### 插件架构
- **接口抽象**: 清晰的接口定义
- **依赖注入**: 控制反转
- **模块热插拔**: 动态模块加载

### 配置灵活性
- **外部配置**: 外部配置文件
- **环境变量**: 环境变量支持
- **运行时调整**: 动态配置更新

## 🧪 测试架构

### 单元测试
- **Mock对象**: 依赖模拟
- **覆盖率**: 代码覆盖率检查
- **基准测试**: 性能基准测试

### 集成测试
- **API测试**: 端到端API测试
- **场景测试**: 业务场景测试
- **压力测试**: 性能压力测试

## 🚀 部署架构

### 容器化部署
- **Docker**: 容器化支持
- **Kubernetes**: 编排支持
- **CI/CD**: 持续集成部署

### 监控告警
- **指标收集**: 性能指标
- **日志系统**: 结构化日志
- **健康检查**: 服务健康监控

## 📊 数据流向

### 用户请求流程
```
用户请求 → HTTP路由 → 认证中间件 → 业务逻辑 → 数据访问 → 响应组装 → 返回结果
```

### AI请求流程
```
用户消息 → 消息预处理 → 上下文构建 → AI调用 → 结果处理 → 响应返回
```

### 记忆存储流程
```
事件发生 → 向量化 → 存储 → 索引 → 检索 → 关联 → 应用
```

## 🔧 维护架构

### 配置管理
- **分级配置**: 默认→全局→局部
- **热加载**: 配置热更新
- **回滚**: 配置版本管理

### 日志管理
- **结构化**: JSON格式日志
- **分级**: 多级别日志
- **归档**: 日志轮转归档

---
*该架构参考了OpenClaw的设计理念，实现了Go语言的高效实现*